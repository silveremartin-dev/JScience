/*+
 * $Id: EarthStation.java,v 1.3 2007-10-21 21:07:05 virtualcall Exp $
 *
 * $Log: not supported by cvs2svn $
 * Revision 1.2  2007/10/21 17:43:15  virtualcall
 * Issue number:
 * Obtained from:
 * Submitted by:
 * Reviewed by:
 *
 * Revision 1.1  2006/09/07 21:14:31  virtualcall
 * Issue number:
 * Obtained from:
 * Submitted by:
 * Reviewed by:
 * CVS: ----------------------------------------------------------------------
 * CVS: Issue number:
 * CVS:   If this change addresses one or more issues,
 * CVS:   then enter the issue number(s) here.
 * CVS: Obtained from:
 * CVS:   If this change has been taken from another system,
 * CVS:   then name the system in this line, otherwise delete it.
 * CVS: Submitted by:
 * CVS:   If this code has been contributed to the project by someone else; i.e.,
 * CVS:   they sent us a patch or a set of diffs, then include their name/email
 * CVS:   address here. If this is your work then delete this line.
 * CVS: Reviewed by:
 * CVS:   If we are doing pre-commit code reviews and someone else has
 * CVS:   reviewed your changes, include their name(s) here.
 * CVS:   If you have not had it reviewed then delete this line.
 *
 * Revision 1.7  2006/07/29 22:14:53  virtualcall
 * Issue number:
 * Obtained from:
 * Submitted by:
 * Reviewed by:
 * CVS: ----------------------------------------------------------------------
 * CVS: Issue number:
 * CVS:   If this change addresses one or more issues,
 * CVS:   then enter the issue number(s) here.
 * CVS: Obtained from:
 * CVS:   If this change has been taken from another system,
 * CVS:   then name the system in this line, otherwise delete it.
 * CVS: Submitted by:
 * CVS:   If this code has been contributed to the project by someone else; i.e.,
 * CVS:   they sent us a patch or a set of diffs, then include their name/email
 * CVS:   address here. If this is your work then delete this line.
 * CVS: Reviewed by:
 * CVS:   If we are doing pre-commit code reviews and someone else has
 * CVS:   reviewed your changes, include their name(s) here.
 * CVS:   If you have not had it reviewed then delete this line.
 *
 * Revision 1.6  2006/07/26 21:23:12  virtualcall
 * Issue number:
 * Obtained from:
 * Submitted by:
 * Reviewed by:
 * CVS: ----------------------------------------------------------------------
 * CVS: Issue number:
 * CVS:   If this change addresses one or more issues,
 * CVS:   then enter the issue number(s) here.
 * CVS: Obtained from:
 * CVS:   If this change has been taken from another system,
 * CVS:   then name the system in this line, otherwise delete it.
 * CVS: Submitted by:
 * CVS:   If this code has been contributed to the project by someone else; i.e.,
 * CVS:   they sent us a patch or a set of diffs, then include their name/email
 * CVS:   address here. If this is your work then delete this line.
 * CVS: Reviewed by:
 * CVS:   If we are doing pre-commit code reviews and someone else has
 * CVS:   reviewed your changes, include their name(s) here.
 * CVS:   If you have not had it reviewed then delete this line.
 *
 * Revision 1.5  2006/07/12 20:35:30  virtualcall
 * Issue number:
 * Obtained from:
 * Submitted by:
 * Reviewed by:
 * CVS: ----------------------------------------------------------------------
 * CVS: Issue number:
 * CVS:   If this change addresses one or more issues,
 * CVS:   then enter the issue number(s) here.
 * CVS: Obtained from:
 * CVS:   If this change has been taken from another system,
 * CVS:   then name the system in this line, otherwise delete it.
 * CVS: Submitted by:
 * CVS:   If this code has been contributed to the project by someone else; i.e.,
 * CVS:   they sent us a patch or a set of diffs, then include their name/email
 * CVS:   address here. If this is your work then delete this line.
 * CVS: Reviewed by:
 * CVS:   If we are doing pre-commit code reviews and someone else has
 * CVS:   reviewed your changes, include their name(s) here.
 * CVS:   If you have not had it reviewed then delete this line.
 *
 * Revision 1.4  2006/07/09 21:13:24  virtualcall
 * Issue number:
 * Obtained from:
 * Submitted by:
 * Reviewed by:
 * CVS: ----------------------------------------------------------------------
 * CVS: Issue number:
 * CVS:   If this change addresses one or more issues,
 * CVS:   then enter the issue number(s) here.
 * CVS: Obtained from:
 * CVS:   If this change has been taken from another system,
 * CVS:   then name the system in this line, otherwise delete it.
 * CVS: Submitted by:
 * CVS:   If this code has been contributed to the project by someone else; i.e.,
 * CVS:   they sent us a patch or a set of diffs, then include their name/email
 * CVS:   address here. If this is your work then delete this line.
 * CVS: Reviewed by:
 * CVS:   If we are doing pre-commit code reviews and someone else has
 * CVS:   reviewed your changes, include their name(s) here.
 * CVS:   If you have not had it reviewed then delete this line.
 *
 * Revision 1.3  2006/07/07 22:32:56  virtualcall
 * Issue number:
 * Obtained from:
 * Submitted by:
 * Reviewed by:
 * CVS: ----------------------------------------------------------------------
 * CVS: Issue number:
 * CVS:   If this change addresses one or more issues,
 * CVS:   then enter the issue number(s) here.
 * CVS: Obtained from:
 * CVS:   If this change has been taken from another system,
 * CVS:   then name the system in this line, otherwise delete it.
 * CVS: Submitted by:
 * CVS:   If this code has been contributed to the project by someone else; i.e.,
 * CVS:   they sent us a patch or a set of diffs, then include their name/email
 * CVS:   address here. If this is your work then delete this line.
 * CVS: Reviewed by:
 * CVS:   If we are doing pre-commit code reviews and someone else has
 * CVS:   reviewed your changes, include their name(s) here.
 * CVS:   If you have not had it reviewed then delete this line.
 *
 * Revision 1.2  2006/07/05 21:04:53  virtualcall
 * Issue number:
 * Obtained from:
 * Submitted by:
 * Reviewed by:
 * CVS: ----------------------------------------------------------------------
 * CVS: Issue number:
 * CVS:   If this change addresses one or more issues,
 * CVS:   then enter the issue number(s) here.
 * CVS: Obtained from:
 * CVS:   If this change has been taken from another system,
 * CVS:   then name the system in this line, otherwise delete it.
 * CVS: Submitted by:
 * CVS:   If this code has been contributed to the project by someone else; i.e.,
 * CVS:   they sent us a patch or a set of diffs, then include their name/email
 * CVS:   address here. If this is your work then delete this line.
 * CVS: Reviewed by:
 * CVS:   If we are doing pre-commit code reviews and someone else has
 * CVS:   reviewed your changes, include their name(s) here.
 * CVS:   If you have not had it reviewed then delete this line.
 *
 * Revision 1.1  2006/07/04 21:46:52  virtualcall
 * Issue number:
 * Obtained from:
 * Submitted by:
 * Reviewed by:
 * CVS: ----------------------------------------------------------------------
 * CVS: Issue number:
 * CVS:   If this change addresses one or more issues,
 * CVS:   then enter the issue number(s) here.
 * CVS: Obtained from:
 * CVS:   If this change has been taken from another system,
 * CVS:   then name the system in this line, otherwise delete it.
 * CVS: Submitted by:
 * CVS:   If this code has been contributed to the project by someone else; i.e.,
 * CVS:   they sent us a patch or a set of diffs, then include their name/email
 * CVS:   address here. If this is your work then delete this line.
 * CVS: Reviewed by:
 * CVS:   If we are doing pre-commit code reviews and someone else has
 * CVS:   reviewed your changes, include their name(s) here.
 * CVS:   If you have not had it reviewed then delete this line.
 *
 * Revision 1.1  2006/06/27 21:35:39  virtualcall
 * Issue number:
 * Obtained from:
 * Submitted by:
 * Reviewed by:
 * CVS: ----------------------------------------------------------------------
 * CVS: Issue number:
 * CVS:   If this change addresses one or more issues,
 * CVS:   then enter the issue number(s) here.
 * CVS: Obtained from:
 * CVS:   If this change has been taken from another system,
 * CVS:   then name the system in this line, otherwise delete it.
 * CVS: Submitted by:
 * CVS:   If this code has been contributed to the project by someone else; i.e.,
 * CVS:   they sent us a patch or a set of diffs, then include their name/email
 * CVS:   address here. If this is your work then delete this line.
 * CVS: Reviewed by:
 * CVS:   If we are doing pre-commit code reviews and someone else has
 * CVS:   reviewed your changes, include their name(s) here.
 * CVS:   If you have not had it reviewed then delete this line.
 *
 * Revision 4.1  2004/08/09 07:53:06  hme
 * Version 2.1.1.
 *
 * Revision 3.1  2004/07/28 10:47:43  hme
 * Version 2.1.
 *
 * Revision 2.6  2004/02/02 23:17:26  hme
 * Added ReadByName.
 *
 * Revision 2.5  2003/09/16 16:49:50  hme
 * Package review.
 *
 * Revision 2.4  2003/09/15 17:11:12  hme
 * Changed method name to GetX0Z.
 *
 * Revision 2.2  2003/09/15 12:38:44  hme
 * Add the copy() method and the Get{Name|Long|Height}() methods it requires.
 *
 * Revision 1.14  2003/06/15 13:58:07  hme
 * Change default to Edinburgh (the city).
 *
 * Revision 1.12  2003/04/21 19:16:56  hme
 * Change default to Royal Observatory Edinburgh.
 *
 * Revision 1.11  2003/04/19 14:02:58  hme
 * Fix confusion of y and z in documentation.
 *
 * Revision 1.9  2002/07/13 19:44:23  hme
 * Consolidate documentation.
 *
 * Revision 1.6  2002/06/22 09:52:35  hme
 * CommandShow() moved to Telescope class.
 *
 * Revision 1.5  2002/06/21 21:01:14  hme
 * GetXYZ() and GetLat().
 *
 * Revision 1.4  2002/06/17 20:22:50  hme
 * Fixed bug whereby latitude was printed as alleged altitude.
 *
 * Revision 1.1  2002/06/15 14:45:47  hme
 * Initial revision
 *
 *-*/

package org.jscience.astronomy.solarsystem;

import org.jscience.astronomy.MiscellaneousUtils;
import org.jscience.astronomy.Station;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.io.PrintStream;


/**
 * <p>The <code>Station</code> class represents an observatory (a location on
 * the Earth's surface) that has a clock.
 * <p/>
 * <p>Copyright: &copy; 2002, 2004 Horst Meyerdierks.
 * <p/>
 * <p>This programme is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public Licence as
 * published by the Free Software Foundation; either version 2 of
 * the Licence, or (at your option) any later version.
 * <p/>
 * <p>This programme is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public Licence for more details.
 * <p/>
 * <p>You should have received a copy of the GNU General Public Licence
 * along with this programme; if not, write to the Free Software
 * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 * <p/>
 * <p>$Id: EarthStation.java,v 1.3 2007-10-21 21:07:05 virtualcall Exp $
 * <p/>
 * <dl>
 * <dt><strong>2.6:</strong> 2004/02/02 hme
 * <dd>Added ReadByName.
 * <dt><strong>2.5:</strong> 2003/09/16 hme
 * <dd>Package review.
 * <dt><strong>2.4:</strong> 2003/09/15 hme
 * <dd>Changed method name to GetX0Z.
 * <dt><strong>2.2:</strong> 2003/09/15 hme
 * <dd>Add the copy() method and the Get{Name|Long|Height}() methods it
 * requires.
 * <dt><strong>1.14:</strong> 2003/06/15 hme
 * <dd>Change default to Edinburgh (the city).
 * <dt><strong>1.12:</strong> 2003/04/21 hme
 * <dd>Change default to Royal Observatory Edinburgh.
 * <dt><strong>1.9:</strong> 2002/07/13 hme
 * <dd>Consolidate documentation.
 * <dt><strong>1.6:</strong> 2002/06/22 hme
 * <dd>CommandShow() moved to Telescope class.
 * <dt><strong>1.5:</strong> 2002/06/21 hme
 * <dd>GetXYZ() and GetLat().
 * <dt><strong>1.2:</strong> 2002/06/15 hme
 * <dd>Translated from C (Sputnik 1.9).
 * </dl>
 *
 * @author Horst Meyerdierks, c/o Royal Observatory,
 *         Blackford Hill, Edinburgh, EH9 3HJ, Scotland;
 *         &lt; hme &#64; roe.ac.uk &gt;
 * @see org.jscience.astronomy.solarsystem.sputnik
 */

//for which we could use org.jscience.geography.coordinates system
public class EarthStation extends Station {

    /**
     * Earth's equatorial radius in Gm.
     */
    private static final double A = 0.006378140;

    /**
     * Earth's polar radius in Gm.
     */
    private static final double B = 0.006356775;

    /**
     * A measure of Earth's flattening.
     * <p/>
     * <p>B = (1 - 1/F) A
     */
    private static final double F = 298.257;

    /**
     * Distance from Earth's axis in m.
     * <p/>
     * <p>This is the projection onto the equatorial plane of the vector from the
     * geocentre to the station.
     */

    private double itsX;

    /**
     * Distance from Earth's equatorial plane in m.
     * <p/>
     * <p>This is the projection onto the rotation axis of the vector from the
     * geocentre to the station.
     */

    private double itsZ;

    /**
     * Initialise the object.
     * <p/>
     * <p>This initialises the JulianTime part, then sets the location to
     * Edinburgh.
     */
    public EarthStation() {

        super("Edinburgh",
                -3.217 / MiscellaneousUtils.DEGREES_PER_RADIAN,
                +55.950 / MiscellaneousUtils.DEGREES_PER_RADIAN,
                50.);

    }

    /**
     * Initialise the object.
     */
    public EarthStation(String name, double longitude, double latitude, double height) {

        super(name, longitude, latitude, height);

    }

    /**
     * Serve the <code>station/read</code> command.
     * <p/>
     * <p>This reads the parameters of the observatory location from a file.  The
     * command line includes both the file name and the name of the station to
     * look for in the file.  The file with a station list looks somewhat like
     * this:
     * <p/>
     * <pre>
     * # List of observatories, one per line.
     * #   East longitude [deg],
     * #   north latitude [deg],
     * #   altitude above geoid [m],
     * #   name (in a pair of double quotes).
     * +6.723    +50.570     435 "Stockert"
     * +6.885    +50.527     369 "Effelsberg"
     * -3.183    +55.925     146 "Royal Observatory Edinburgh"
     * -0.528    +44.835      73 "Floirac"
     * </pre>
     * <p/>
     * <p>When it is read, the station names in the double quotes are looked for.
     * The line that makes a match with the requested station will then be
     * scanned for the three numbers at the line's beginning.  The numbers are
     * longitude and latitude in degrees and height above sea level in metres.
     *
     * @param aCommand The command line, including the parameters to be read.
     */
    public void commandRead(String aCommand) throws Exception, IOException {

        BufferedReader theFile;
        String theString;
        String theFileName;
        String theName;

        /* Trim off the command itself and read the file name. */

        theString = aCommand.substring(13);
        theFileName = MiscellaneousUtils.deQuoteString(theString);

        /* Trim off the file name and read the station name. */

        theString = MiscellaneousUtils.stringRemainder(theString);
        theName = MiscellaneousUtils.deQuoteString(theString);

        /* Delegate the work to another method. */

        readByName(theFileName, theName);

    }

    /**
     * Read Station from file.
     * <p/>
     * <p>This reads the parameters of the observatory location from a file.
     * The file with a station list looks somewhat like this:
     * <p/>
     * <pre>
     * # List of observatories, one per line.
     * #   East longitude [deg],
     * #   north latitude [deg],
     * #   altitude above geoid [m],
     * #   name (in a pair of double quotes).
     * +6.723    +50.570     435 "Stockert"
     * +6.885    +50.527     369 "Effelsberg"
     * -3.183    +55.925     146 "Royal Observatory Edinburgh"
     * -0.528    +44.835      73 "Floirac"
     * </pre>
     * <p/>
     * <p>When it is read, the station names in the double quotes are looked for.
     * The line that makes a match with the requested station will then be
     * scanned for the three numbers at the line's beginning.  The numbers are
     * longitude and latitude in degrees and height above sea level in metres.
     *
     * @param aFileName The name of the file with the station data.
     * @param aName     The name of the observatory to be looked for in the file.
     */
    public void readByName(String aFileName, String aName)
            throws Exception, IOException {

        BufferedReader theFile;
        String theString;
        double theLong;
        double theLat;
        double theHeight;
        boolean success = false;

        /* Open the file named in the first word. */

        theFile = new BufferedReader(new FileReader(aFileName));

        /* Loop through file. */

        for (; ;) {

            /* Read line.  An EOF is
* signalled by returning null.  In that case we break the loop. */

            if ((theString = theFile.readLine()) == null) break;

            /* Trim white space off the start and end.
    * If we have a comment, ignore it. */

            theString = theString.trim();
            if (theString.startsWith("#")) {
                continue;
            }

            /* Read the three numbers and the name.
* We skip the numbers as if they were words separated by blanks. */

            theLong = MiscellaneousUtils.readFloat(theString);
            theString = MiscellaneousUtils.stringRemainder(theString);
            theLat = MiscellaneousUtils.readFloat(theString);
            theString = MiscellaneousUtils.stringRemainder(theString);
            theHeight = MiscellaneousUtils.readFloat(theString);
            theString = MiscellaneousUtils.stringRemainder(theString);
            theString = MiscellaneousUtils.deQuoteString(theString);

            /* If the station names match, set the instance and break out. */

            if (aName.equals(theString)) {
                setGeodetic(aName,
                        theLong / MiscellaneousUtils.DEGREES_PER_RADIAN,
                        theLat / MiscellaneousUtils.DEGREES_PER_RADIAN,
                        theHeight / 1E9);
                success = true;
                break;
            }
        }

        theFile.close();
        if (!success) {
            theFile.close();
            throw new Exception("no such station");
        }

    }

    /**
     * Return local sidereal time.
     * <p/>
     * <p>This returns the local sidereal time (sidereal time since previous
     * culmination of the mean equinox at the observatory) in hours.  LST is the
     * right ascension of the station, which is of course set off from Greenwich
     * by its geographic longitude.  Hence:
     * <p/>
     * <p>LST = GST + &lambda;
     */
    public final JulianTime getLocalSideralTime(JulianTime time) {

        double theRetval;

        theRetval = time.getGreenwichSideralTime();
        theRetval += getLongitude() * 12. / Math.PI;
        while (0. > theRetval) theRetval += 24.;
        while (24. <= theRetval) theRetval -= 24.;

        return new JulianTime(theRetval);

    }

    /**
     * Return local sidereal time as triplet.
     * <p/>
     * <p>This returns the local sidereal time (sidereal time since previous
     * culmination of the mean equinox at the observatory) as a
     * triplet of hours (0-23), minutes (0-59) and seconds (0-60.0).
     * See {@link #getLocalSideralTime getLocalSideralTime} for a definition of LST.
     *
     * @return aTriplet
     *         The returned triplet of hours, minutes and seconds.
     */
    public final double[] getLocalSideralTimeAshms(JulianTime time) {

        JulianTime theTime;

        theTime = getLocalSideralTime(time);
        return MiscellaneousUtils.degreesTodms(theTime.getJulianDay());

    }

    /**
     * Return the station rectangular position.
     * <p/>
     * <p>This gives access to the stored fields itsX and itsZ.  The second
     * returned number is always zero, as here the x axis is in the meridian of
     * the Station, not of Greenwich.  The numbers are in m.
     *
     * @return aTriplet
     *         The geocentric rectangular coordinates in the coordinate system where
     *         the x-z plane is the plane of the observatory's meridian.  The second
     *         number is therefore always returned as zero.
     */
    public final double[] getX0Z() {

        double[] aTriplet;

        aTriplet = new double[3];
        aTriplet[0] = itsX;
        aTriplet[1] = 0.;
        aTriplet[2] = itsZ;

        return aTriplet;

    }

    /**
     * Set the station parameters.
     * <p/>
     * <p>Given the longitude and latitude in radian and the height in m, this
     * will store the numbers in the class instance and calculate the remaining
     * station parameters accordingly.  The longitude is normalised to the
     * interval [-&pi;,+&pi;].
     * <p/>
     * <p><img src="figs/Station1.png" alt="Meridian cut">
     * <p><em>Cut through the ellipsoidal geoid along
     * the meridian of the station.</em>
     * <p/>
     * <p>The meridian through the station is an ellipse marking the sea level,
     * or the surface of the geoid.  The radii of the geoid are a at the equator
     * and b at the pole.  The equation of the ellipse is
     * <p/>
     * <p>(x<sup>2</sup> / a<sup>2</sup>) + (z<sup>2</sup> / b<sup>2</sup>) = 1
     * <p/>
     * <p>The horizon is the tangential plane to the geoid.  Since the geoid is
     * an equi-potential surface, the normal to the horizon is defined by the
     * direction of the gravi-centrifugal force.  Hence the geodetic latitude
     * can be defined as the elevation of the north celestial pole above the
     * horizon.  The equation of the horizon is
     * (Helmut Sieber, 1973, <I>Mathematische Begriffe und Formeln</I>, Klett, Stuttgart)
     * <p/>
     * <p>(x x<sub>0</sub> / a<sup>2</sup>)
     * + (z z<sub>0</sub> /b<sup>2</sup>) = 1
     * <p/>
     * <p>Considering the slope of the horizon we find
     * <p/>
     * <p>cot(&phi;) = &plusmn;
     * (b<sup>2</sup> / a<sup>2</sup>) (x<sub>0</sub> / z<sub>0</sub>)
     * <p/>
     * <p>With some arithmetics these two equations result in expressions of the
     * coordinates as function of the geodetic latitude.  The effect of the
     * station's altitude above the geoid is simple to calculate from the
     * geodetic latitude and this all combines to
     * <p/>
     * <p>x<sub>1</sub> = h cos(&phi;)
     * + a [1 - [1 / {1 + (a/b)<sup>2</sup>
     * cot<sup>2</sup>(&phi;)}]]<sup>0.5</sup>
     * <p>z<sub>1</sub> = h sin(&phi;) &plusmn;
     * b [1 / {1 + (a/b)<sup>2</sup> cot<sup>2</sup>(&phi;)}]<sup>0.5</sup>
     * <p>&phi;' = arctan(z<sub>1</sub>/x<sub>1</sub>)
     * <p>r = (x<sub>1</sub><sup>2</sup>
     * + z<sub>1</sub><sup>2</sup>)<sup>0.5</sup>
     * <p/>
     * <p>To give an idea of the magnitude of the difference between geodetic and
     * geocentric latitude, at 56&#176; the geocentric latitude is smaller by
     * 0.18&#176;.
     *
     * @param aName   The name of the observatory.
     * @param aLong   The geographic longitude in rad.
     * @param aLat    The geodetic latitude in rad.
     * @param aHeight The elevation above sea level in m.
     */
    public final void setGeodetic(String aName,
                                  double aLong, double aLat, double aHeight) {

        double theFactor;

        /* copy the parameters into fields, normalise longitude. */

        setName(aName);
        setLongitude(MiscellaneousUtils.normalizeAngleAt0(aLong));
        setLatitude(aLat);
        setHeight(aHeight);

        /* Work out the geocentric description for latitude and height.
* Above we defined F = 1/f, which we use instead of
* (a/b)^2 = [F/(F-1)]^2.  The equations in the documentation don't work
* on the poles or on the equator, where life is in fact simpler. */

        if (getLatitude() <= -Math.PI / 2.) {
            itsX = 0.;
            itsZ = +B;
        } else if (getLatitude() >= +Math.PI / 2.) {
            itsX = 0.;
            itsZ = -B;
        } else if (1E-6 > Math.abs(getLatitude())) {
            itsX = A * Math.cos(getLatitude());
            itsZ = A * Math.sin(getLatitude());
        } else if (0. < getLatitude()) {
            theFactor = F / (F - 1.);
            theFactor /= Math.tan(getLatitude());
            theFactor *= theFactor;
            itsX = getHeight() * Math.cos(getLatitude())
                    + A * Math.sqrt(1. - 1. / (1. + theFactor));
            itsZ = getHeight() * Math.sin(getLatitude())
                    + B * Math.sqrt(1. / (1. + theFactor));
        } else {
            theFactor = F / (F - 1.);
            theFactor /= Math.tan(getLatitude());
            theFactor *= theFactor;
            itsX = getHeight() * Math.cos(getLatitude())
                    + A * Math.sqrt(1. - 1. / (1. + theFactor));
            itsZ = getHeight() * Math.sin(getLatitude())
                    - B * Math.sqrt(1. / (1. + theFactor));
        }

    }

    /**
     * Set the station rectangular position.
     * <p/>
     * <p>Given the rectangular coordinates in m this fills in the instance
     * correctly.  The x axis points to the Gulf of Guinea (longitude and
     * latitude zero), the y axis to the Indian Ocean and the z axis to the
     * North Pole.
     * <p/>
     * <p><img src="figs/Station1.png" alt="Meridian cut">
     * <p><em>Cut through the ellipsoidal geoid along
     * the meridian of the station.</em>
     * <p/>
     * <p>To convert from geocentric latitude &phi;'
     * to geodetic (geographic) latitude &phi; we use the iteration of
     * (USNO/RGO, 1990, <I>The Astronomical Almanach for the Year 1992</I>, U.S. Government Printing Office, Washington DC, Her Majesty's Stationery Office, London, p.K12).
     * The starting value is the geocentric latitude.  In the iteration the
     * distance r from the axis and the eccentricity e are used.
     * <p/>
     * <p>r = (x<sub>1</sub><sup>2</sup>
     * + z<sub>1</sub><sup>2</sup>)<sup>0.5</sup>
     * <p>e<sup>2</sup> = 1 - (b/a)<sup>2</sup> = 2 f - f<sup>2</sup>
     * <p>&phi;(1) = &phi;'
     * <p>C(i) = [1 / {1 - e<sup>2</sup>
     * sin<sup>2</sup>(&phi;(i))}<sup>0.5</sup>]
     * <p>&phi;(i+1) = arctan[(z + a C(i) e<sup>2</sup> sin(&phi;(i))) / r]
     * <p>h = [r / cos(&phi;(&infin;))] - a C(&infin;)
     *
     * @param aName    The name of the observatory.
     * @param aTriplet The geocentric rectangular coordinates in the coordinate system where
     *                 the x axis points to the Gulf of Guinea.
     */
    public final void setXYZ(String aName, double aTriplet[]) {

        double theEsquare;
        double theOldLat;
        double theC;
        double theTriplet[] = new double[3];

        /* copy given name. */

        setName(aName);

        /* Prepare iteration. */

        theEsquare = 2. / F - 1. / (F * F);
        theTriplet = MiscellaneousUtils.convertOrthogonalToSpherical(aTriplet);
        setLongitude(MiscellaneousUtils.normalizeAngleAt0(theTriplet[0]));
        setLatitude(theTriplet[1]);
        itsX = Math.sqrt(aTriplet[0] * aTriplet[0] + aTriplet[1] * aTriplet[1]);
        itsZ = aTriplet[2];

        /* Iterate. */

        for (; ;) {
            theOldLat = getLatitude();
            theC = 1. / Math.sqrt(1.
                    - theEsquare * Math.sin(theOldLat) * Math.sin(theOldLat));
            setLatitude(Math.atan((itsZ + A * theC * theEsquare * Math.sin(theOldLat)) / itsX));
            if (1E-7 > Math.abs(getLatitude() - theOldLat)) break;
        }

        /* Altitude. */

        setHeight(itsX / Math.cos(getLatitude()) - A * theC);
    }

    /**
     * Display the position and time in various representations.
     * <p/>
     * <p>This writes information about the currently stored observatory position
     * and time to the given open file.  The format is
     * <p/>
     * <pre>
     * Observatory: Royal Observatory Edinburgh
     * East long.   -3.182500 deg
     * Latitude     55.925000 deg
     * Altitude           146 m
     * <p/>
     * UT: 2003-04-21-19:15:33.1 (JD  2452751.302467)
     * TT: 2003-04-21-19:16:38.9 (JDE 2452751.303228)
     * Ep: 2003.302678243
     * GST 09:13:21.0 = 138.337426 deg
     * LST 09:00:37.2 = 135.154926 deg
     * </pre>
     *
     * @param aFile The output stream to which to write the information.
     */
    public final void showToFile(PrintStream aFile, JulianTime time) {

        double theLST[];

        aFile.print("\nObservatory: " + getName() + "\n   East long. ");
        MiscellaneousUtils.writeFloat(aFile, 11, 6, getLongitude() * MiscellaneousUtils.DEGREES_PER_RADIAN);
        aFile.print(" deg\n   Latitude    ");
        MiscellaneousUtils.writeFloat(aFile, 10, 6, getLatitude() * MiscellaneousUtils.DEGREES_PER_RADIAN);
        aFile.print(" deg\n   Altitude          ");
        MiscellaneousUtils.writeFloat(aFile, 4, 0, getHeight() * 1E9);
        aFile.print(" m\n\n");

        //super.showToFile(aFile);

        theLST = getLocalSideralTimeAshms(time);
        aFile.print("             LST ");
        MiscellaneousUtils.writeExtendedTime(aFile, theLST[0], theLST[1], theLST[2]);
        aFile.print(" = ");
        MiscellaneousUtils.writeFloat(aFile, 10, 6,
                (theLST[0] + (theLST[1] + theLST[2] / 60.) / 60.) * 15.);
        aFile.println(" deg\n");
    }

}
